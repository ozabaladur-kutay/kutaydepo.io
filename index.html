<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KutOS 2.0 MasaÃ¼stÃ¼ SimÃ¼lasyonu</title>
    <link rel="stylesheet" href="desktop.css">
</head>
<body>
    
    <div id="desktop">

        <div class="desktop-icon" id="file-manager-icon" draggable="false">
            <span class="icon-emoji">ğŸ“</span>
            <span class="icon-label">Dosya YÃ¶neticisi</span>
        </div>
        
        <div class="desktop-icon" id="settings-icon-desktop" draggable="false">
            <span class="icon-emoji">âš™ï¸</span>
            <span class="icon-label">Ayarlar</span>
        </div>
        
        <div class="desktop-icon" id="browser-icon" draggable="false">
            <span class="icon-emoji">ğŸŒ</span>
            <span class="icon-label">Kut Browser</span>
        </div>
        
        <div class="window" id="file-manager-window">
            <div class="window-header">
                <span class="window-title">ğŸ“ Dosya YÃ¶neticisi</span>
                <div class="window-controls">
                    <button class="minimize-btn">â–</button>
                    <button class="maximize-btn">ğŸ—–</button>
                    <button class="close-btn">âŒ</button>
                </div>
            </div>
            <div class="window-content file-manager-content">
                <h3 id="current-path">/</h3>
                <div id="file-list">
                    </div>
            </div>
        </div>

        <div class="window" id="text-editor-window">
            <div class="window-header">
                <span class="window-title" id="text-editor-title">ğŸ“„ Metin EditÃ¶rÃ¼</span>
                <div class="window-controls">
                    <button class="minimize-btn">â–</button>
                    <button class="maximize-btn">ğŸ—–</button>
                    <button class="close-btn">âŒ</button>
                </div>
            </div>
            <div class="window-content text-editor-content">
                <div class="editor-menu">
                    <button id="editor-save-btn">ğŸ’¾ Kaydet</button>
                    <button id="editor-clear-btn">âœ–ï¸ Temizle</button>
                </div>
                <textarea id="editor-textarea" placeholder="Buraya yazabilirsiniz..."></textarea>
            </div>
        </div>

        <div class="window" id="settings-window">
            <div class="window-header">
                <span class="window-title">âš™ï¸ Ayarlar</span>
                <div class="window-controls">
                    <button class="minimize-btn">â–</button>
                    <button class="maximize-btn">ğŸ—–</button>
                    <button class="close-btn">âŒ</button>
                </div>
            </div>
            <div class="window-content settings-content">
                <h3>KutOS AyarlarÄ±</h3>
                <p>Tema: Koyu Mor (Aktif)</p>
                <div class="setting-group">
                    <h4>Arka Plan</h4>
                    <button id="set-bg-default" class="settings-btn active-setting">VarsayÄ±lan Duvar KaÄŸÄ±dÄ±</button>
                    <button id="set-bg-solid" class="settings-btn">DÃ¼z Siyah Arka Plan</button>
                </div>
            </div>
        </div>

        <div class="window" id="calculator-window">
            <div class="window-header">
                <span class="window-title">ğŸ§® Hesap Makinesi</span>
                <div class="window-controls">
                    <button class="minimize-btn">â–</button>
                    <button class="maximize-btn">ğŸ—–</button>
                    <button class="close-btn">âŒ</button>
                </div>
            </div>
            <div class="window-content calculator-content">
                <input type="text" id="calculator-display" value="0" disabled>
                <div class="calculator-buttons">
                    <button class="btn clear" data-action="clear">AC</button>
                    <button class="btn operator" data-action="sign">Â±</button>
                    <button class="btn operator" data-action="percent">%</button>
                    <button class="btn operator op-color" data-action="divide">Ã·</button>

                    <button class="btn number" data-value="7">7</button>
                    <button class="btn number" data-value="8">8</button>
                    <button class="btn number" data-value="9">9</button>
                    <button class="btn operator op-color" data-action="multiply">x</button>

                    <button class="btn number" data-value="4">4</button>
                    <button class="btn number" data-value="5">5</button>
                    <button class="btn number" data-value="6">6</button>
                    <button class="btn operator op-color" data-action="subtract">-</button>

                    <button class="btn number" data-value="1">1</button>
                    <button class="btn number" data-value="2">2</button>
                    <button class="btn number" data-value="3">3</button>
                    <button class="btn operator op-color" data-action="add">+</button>

                    <button class="btn number zero" data-value="0">0</button>
                    <button class="btn number" data-value=".">.</button>
                    <button class="btn equals op-color" data-action="calculate">=</button>
                </div>
            </div>
        </div>

        <div class="window" id="security-window">
            <div class="window-header">
                <span class="window-title">ğŸ›¡ï¸ KutOS GÃ¼venlik</span>
                <div class="window-controls">
                    <button class="minimize-btn">â–</button>
                    <button class="maximize-btn">ğŸ—–</button>
                    <button class="close-btn">âŒ</button>
                </div>
            </div>
            <div class="window-content security-content">
                <h3>Sistem GÃ¼venlik Durumu</h3>
                <div id="security-status" style="padding: 10px; border: 1px solid #4CAF50; background-color: #e8f5e9; color: #4CAF50; margin-bottom: 15px; border-radius: 4px;">
                    âœ… Sistem GÃ¼venli: Her ÅŸey yolunda.
                </div>
                
                <p>Son Tarama: Az Ã¶nce</p>
                <button id="start-scan-btn" class="settings-btn">VirÃ¼s TaramasÄ± BaÅŸlat</button>
                
                <div id="scan-result" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div class="window" id="browser-window">
            <div class="window-header">
                <span class="window-title">ğŸŒ Kut Browser</span>
                <div class="window-controls">
                    <button class="minimize-btn">â–</button>
                    <button class="maximize-btn">ğŸ—–</button>
                    <button class="close-btn">âŒ</button>
                </div>
            </div>
            <div class="window-content browser-content">
                <iframe 
                    id="browser-iframe" 
                    src="https://www.google.com/webhp?igu=1" 
                    frameborder="0"
                ></iframe>
            </div>
        </div>
        
        <div id="context-menu" class="context-menu">
            <div class="menu-item" id="menu-create-folder">ğŸ“ Yeni KlasÃ¶r OluÅŸtur</div>
            <div class="menu-item" id="menu-create-file">ğŸ“„ Yeni Metin Belgesi</div>
            <div class="menu-item separator"></div>
            <div class="menu-item" id="menu-refresh">ğŸ”„ Yenile</div>
            <div class="menu-item separator"></div>
            <div class="menu-item" id="menu-view-settings">âš™ï¸ GÃ¶rÃ¼ntÃ¼ AyarlarÄ±</div>
        </div>
        
        <div id="folder-context-menu" class="context-menu">
            <div class="menu-item" id="menu-open-folder">ğŸ“‚ AÃ§</div>
            <div class="menu-item" id="menu-rename-item">âœï¸ Yeniden AdlandÄ±r</div>
            <div class="menu-item separator"></div>
            <div class="menu-item" id="menu-delete-folder">ğŸ—‘ï¸ Sil</div>
        </div>
        
    </div>
    
    <div id="start-menu">
        <div class="menu-header">KutOS 2.0</div>
        <a href="#" class="menu-item" id="menu-file-manager">ğŸ“ Dosya YÃ¶neticisi</a>
        <a href="#" class="menu-item" id="menu-text-editor">ğŸ“„ Metin EditÃ¶rÃ¼</a>
        <a href="#" class="menu-item" id="menu-settings">âš™ï¸ Ayarlar</a>
        <a href="#" class="menu-item" id="menu-calculator">ğŸ§® Hesap Makinesi</a>
        <a href="#" class="menu-item" id="menu-security">ğŸ›¡ï¸ KutOS GÃ¼venlik</a>
        <a href="#" class="menu-item" id="menu-browser">ğŸŒ Kut Browser</a>
        <a href="#" class="menu-item power-button" id="menu-power-off">ğŸšª Kapat</a>
    </div>

    <div id="taskbar">
        
        <div id="start-button">
            <span class="logo-text">KutOS</span>
        </div>
        
        <div id="running-apps">
            <div class="taskbar-icon" id="file-manager-taskbar-icon">
                ğŸ“
            </div>
            <div class="taskbar-icon" id="text-editor-taskbar-icon">
                ğŸ“„
            </div>
            <div class="taskbar-icon" id="settings-taskbar-icon">
                âš™ï¸
            </div>
            <div class="taskbar-icon" id="calculator-taskbar-icon">
                ğŸ§®
            </div>
            <div class="taskbar-icon" id="security-taskbar-icon">
                ğŸ›¡ï¸
            </div>
            <div class="taskbar-icon" id="browser-taskbar-icon">
                ğŸŒ
            </div>
        </div>
        
        <div id="system-tray">
            <span id="time">11:25</span>
            <span id="settings-icon">âš™ï¸</span>
        </div>
    </div>
    
    <script>
        
        // --- 1. BaÅŸlat MenÃ¼sÃ¼ ve MasaÃ¼stÃ¼ TÄ±klama KontrolÃ¼ ---
        const startButton = document.getElementById('start-button');
        const startMenu = document.getElementById('start-menu');
        const contextMenu = document.getElementById('context-menu');
        const folderContextMenu = document.getElementById('folder-context-menu');
        let activeFolderIcon = null; 
        
        startButton.addEventListener('click', (e) => {
            e.stopPropagation(); 
            startMenu.style.display = startMenu.style.display === 'block' ? 'none' : 'block';
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#start-menu') && !e.target.closest('#start-button')) {
                startMenu.style.display = 'none';
            }
            if (!e.target.closest('#context-menu')) {
                contextMenu.style.display = 'none';
            }
            if (!e.target.closest('#folder-context-menu')) {
                folderContextMenu.style.display = 'none';
                activeFolderIcon = null;
            }
        });

        // --- 2. Saat GÃ¼ncelleme ---
        function updateTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0'); 
            document.getElementById('time').textContent = `${hours}:${minutes}`;
        }
        updateTime();
        setInterval(updateTime, 60000); 
        
        // --- 3. Pencere Kontrol FonksiyonlarÄ± ---
        function setupWindowControls(windowElement, taskbarIconElement) { 
            const minimizeBtn = windowElement.querySelector('.minimize-btn');
            const maximizeBtn = windowElement.querySelector('.maximize-btn');
            const closeBtn = windowElement.querySelector('.close-btn');
            
            closeBtn.addEventListener('click', () => {
                windowElement.style.display = 'none';
                if(taskbarIconElement) taskbarIconElement.classList.remove('active');
                
                // Metin EditÃ¶rÃ¼nÃ¼ kapatÄ±nca iÃ§eriÄŸini temizle
                if (windowElement.id === 'text-editor-window') {
                    currentEditingFileId = null;
                    editorTextarea.value = '';
                    editorTextarea.disabled = false;
                    editorTitle.textContent = `ğŸ“„ Metin EditÃ¶rÃ¼`;
                    editorSaveBtn.style.display = 'inline-block';
                }
            });
            
            maximizeBtn.addEventListener('click', () => {
                windowElement.classList.toggle('maximized');
            });
            
            minimizeBtn.addEventListener('click', () => {
                windowElement.style.display = 'none';
                if(taskbarIconElement) {
                    taskbarIconElement.classList.remove('active');
                    taskbarIconElement.classList.add('minimized');
                }
            });

            if (taskbarIconElement) {
                taskbarIconElement.addEventListener('click', () => {
                    if (windowElement.style.display === 'block') {
                        windowElement.style.display = 'none';
                        taskbarIconElement.classList.remove('active');
                    } else {
                        windowElement.style.display = 'block';
                        windowElement.classList.remove('maximized');
                        taskbarIconElement.classList.add('active');
                        taskbarIconElement.classList.remove('minimized');
                        bringToFront(windowElement);
                    }
                });
            }
        }
        
        // --- 4. SÃ¼rÃ¼kleme Fonksiyonu (Pencereler Ä°Ã§in) ---
        function makeDraggable(windowElement, headerElement) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            headerElement.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                if (windowElement.classList.contains('maximized')) return; 
                
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                bringToFront(windowElement); 
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                windowElement.style.top = (windowElement.offsetTop - pos2) + "px";
                windowElement.style.left = (windowElement.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
        
        // --- 4b. MasaÃ¼stÃ¼ Simgeleri Ä°Ã§in SÃ¼rÃ¼kleme Fonksiyonu ---
        function makeIconDraggable(iconElement) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            iconElement.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault(); 
                
                iconElement.style.zIndex = '100'; 
                
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                let newTop = (iconElement.offsetTop - pos2);
                let newLeft = (iconElement.offsetLeft - pos1);
                
                // SINIR KONTROLÃœ
                const taskbarHeight = 40;
                
                if (newTop < 0) newTop = 0;
                if (newTop > window.innerHeight - iconElement.offsetHeight - taskbarHeight) {
                    newTop = window.innerHeight - iconElement.offsetHeight - taskbarHeight;
                }
                if (newLeft < 0) newLeft = 0;
                if (newLeft > window.innerWidth - iconElement.offsetWidth) {
                    newLeft = window.innerWidth - iconElement.offsetWidth;
                }

                iconElement.style.top = newTop + "px";
                iconElement.style.left = newLeft + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                iconElement.style.zIndex = '1'; 
                saveIconPosition(iconElement); 
            }
        }

        // --- 5. Pencere OdaÄŸÄ± (Focus) YÃ¶netimi ---
        let highestZIndex = 500; 

        function bringToFront(windowElement) {
            highestZIndex += 1;
            windowElement.style.zIndex = highestZIndex;
        }
        
        function setupWindowFocus(windowElement) {
            windowElement.addEventListener('mousedown', () => {
                bringToFront(windowElement);
            });
        }

        // --- 6. Uygulama BaÅŸlatma Fonksiyonu ---
        function openWindow(windowElement, taskbarIcon) {
            windowElement.style.display = 'block';
            if(taskbarIcon) {
                taskbarIcon.classList.add('active');
                taskbarIcon.classList.remove('minimized');
            }
            startMenu.style.display = 'none';
            bringToFront(windowElement); 
        }

        // --- Ek Fonksiyon: Dinamik MasaÃ¼stÃ¼ Ä°konu OluÅŸturma ---
        const desktopArea = document.getElementById('desktop'); 
        const fileManagerWindow = document.getElementById('file-manager-window');
        const fileManagerTaskbarIcon = document.getElementById('file-manager-taskbar-icon');
        const textEditorWindow = document.getElementById('text-editor-window'); 
        const textEditorTaskbarIcon = document.getElementById('text-editor-taskbar-icon'); 


        // type parametresi eklendi: 'dir' veya 'file'
        function createDesktopIcon(name, id, type) { 
            const newIcon = document.createElement('div');
            newIcon.classList.add('desktop-icon');
            newIcon.id = id;
            newIcon.setAttribute('draggable', 'false'); 
            
            // Ä°kon Emojisini tÃ¼re gÃ¶re belirle
            let iconEmoji = (type === 'file') ? 'ğŸ“„' : 'ğŸ“';

            newIcon.innerHTML = `
                <span class="icon-emoji">${iconEmoji}</span>
                <span class="icon-label">${name}</span>
            `;

            desktopArea.appendChild(newIcon);
            
            // Ã‡ift tÄ±klama olayÄ±nÄ± ekle
            newIcon.addEventListener('dblclick', (e) => {
                e.stopPropagation(); 
                
                if (type === 'dir') {
                    // KlasÃ¶rse Dosya YÃ¶neticisini aÃ§
                    openWindow(fileManagerWindow, fileManagerTaskbarIcon);
                    currentPath = '/' + name; 
                    renderFiles(); 
                } else if (type === 'file') {
                    // Dosyaysa Metin EditÃ¶rÃ¼ ile aÃ§
                    openTextEditor(name);
                }
            });
            
            // SaÄŸ TÄ±k OlayÄ± (Sadece dinamik klasÃ¶r/dosyalar iÃ§in)
            if (type === 'dir' || type === 'file') { 
                newIcon.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation(); 
                    
                    activeFolderIcon = newIcon; 
                    folderContextMenu.style.display = 'block';
                    folderContextMenu.style.left = `${e.clientX}px`;
                    folderContextMenu.style.top = `${e.clientY}px`;
                    contextMenu.style.display = 'none'; 
                });
            }
            
            makeIconDraggable(newIcon);
            return newIcon; 
        }

        // --- YENÄ° KONUM HESAPLAMA MANTIÄI ---
        function findNextAvailableIconPosition() {
            const iconWidth = 80;
            const iconHeight = 80;
            const padding = 20; 
            const taskbarHeight = 40;
            
            // KullanÄ±lan pozisyonlarÄ± topla
            const usedPositions = [];

            // TÃ¼m masaÃ¼stÃ¼ ikonlarÄ±nÄ± al (sabit ve o ana kadar yÃ¼klenmiÅŸ dinamik)
            const allIcons = document.querySelectorAll('#desktop .desktop-icon');
            
            allIcons.forEach(icon => {
                // Sadece top/left stili ayarlanmÄ±ÅŸ olanlarÄ± dikkate al
                if (icon.style.top) {
                    usedPositions.push({ 
                        top: parseInt(icon.style.top), 
                        left: parseInt(icon.style.left) 
                    });
                }
            });

            let nextTop = 20;
            let nextLeft = 20;
            let maxIterations = 500; 
            let iterationCount = 0;
            
            // Ä°konlarÄ± sÃ¼tun dÃ¼zeninde tarar
            while (iterationCount < maxIterations) {
                iterationCount++;

                let isOccupied = false;
                
                // Bu konumun kullanÄ±lÄ±p kullanÄ±lmadÄ±ÄŸÄ±nÄ± kontrol et
                for (const pos of usedPositions) {
                    // Yatayda ve dikeyde yeterince yakÄ±nsa Ã§akÄ±ÅŸma var say (80px ikon + 20px padding)
                    if (Math.abs(pos.top - nextTop) < iconHeight + padding && Math.abs(pos.left - nextLeft) < iconWidth + padding) {
                        isOccupied = true;
                        break;
                    }
                }

                if (!isOccupied) {
                    // BoÅŸ yer bulundu
                    return { top: nextTop + 'px', left: nextLeft + 'px' };
                }
                
                // Bir sonraki konuma geÃ§ (bir sÃ¼tunda aÅŸaÄŸÄ±)
                nextTop += iconHeight + padding; 
                
                // EÄŸer ekran yÃ¼ksekliÄŸini aÅŸtÄ±ysa 
                if (nextTop > window.innerHeight - iconHeight - taskbarHeight - padding) {
                    nextTop = 20; // BaÅŸa dÃ¶n
                    nextLeft += iconWidth + padding; // Yeni sÃ¼tuna geÃ§
                    
                    // Ekran geniÅŸliÄŸini aÅŸtÄ±ysa 
                    if (nextLeft > window.innerWidth - iconWidth - padding) {
                        // Ã‡ok fazla simge var, en baÅŸtan tekrar dene 
                        nextTop = 20; 
                        nextLeft = 20;
                        usedPositions.length = 0; // Tekrar dene
                    }
                }
            }
            // GÃ¼venlik amaÃ§lÄ± bir deÄŸer dÃ¶n
            return { top: '20px', left: '20px' };
        }


        // --- 7. Ä°KON KONUMUNU KALICI KAYDETME MANTIÄI ---

        function saveIconPosition(iconElement) {
            const iconId = iconElement.id;
            const top = iconElement.style.top;
            const left = iconElement.style.left;
            
            // Sabit ikonlar
            if (iconId === 'file-manager-icon' || iconId === 'settings-icon-desktop' || iconId === 'browser-icon') {
                localStorage.setItem(iconId + '_top', top);
                localStorage.setItem(iconId + '_left', left);
            // Dinamik ikonlar
            } else if (iconId.startsWith('new-folder-icon-') || iconId.startsWith('new-file-icon-')) {
                let items = JSON.parse(localStorage.getItem('dynamicDesktopItems')) || {};
                if (items[iconId]) {
                    items[iconId].top = top;
                    items[iconId].left = left;
                    localStorage.setItem('dynamicDesktopItems', JSON.stringify(items));
                }
            }
        }

        function loadIconPositions() {
            const fixedIcons = document.querySelectorAll('#file-manager-icon, #settings-icon-desktop, #browser-icon');

            fixedIcons.forEach(iconElement => {
                const iconId = iconElement.id;
                const savedTop = localStorage.getItem(iconId + '_top');
                const savedLeft = localStorage.getItem(iconId + '_left');

                // KonumlarÄ± YÃ¼kle veya VarsayÄ±lan KonumlarÄ±nÄ± Kullan
                if (savedTop && savedLeft) {
                    iconElement.style.top = savedTop;
                    iconElement.style.left = savedLeft;
                }
                makeIconDraggable(iconElement); // SÃ¼rÃ¼kleme Ã¶zelliÄŸini tekrar yÃ¼kle
            });
            
            loadDynamicItems();
        }

        // --- 8. DÄ°NAMÄ°K KLASÃ–R/DOSYA OLUÅTURMA VE KAYIT MANTIÄI ---

        function saveDynamicItem(itemName, iconId, top, left, type, content = '') { 
            let items = JSON.parse(localStorage.getItem('dynamicDesktopItems')) || {};
            
            items[iconId] = { 
                name: itemName, 
                top: top, 
                left: left,
                type: type, 
                content: content 
            };
            
            localStorage.setItem('dynamicDesktopItems', JSON.stringify(items));
        }

        function loadDynamicItems() {
            const items = JSON.parse(localStorage.getItem('dynamicDesktopItems')) || {};
            
            // Sadece dinamik olarak eklenen simgeleri bul ve kaldÄ±r (id'leri 'new-' ile baÅŸlÄ±yor)
            document.querySelectorAll('.desktop-icon').forEach(icon => {
                if (icon.id.startsWith('new-')) {
                    icon.remove();
                }
            });
            
            for (const iconId in items) {
                const itemData = items[iconId];
                const itemName = itemData.name;
                const itemType = itemData.type; 
                
                // Resim dosyasÄ±ndan kalan verileri atla
                if (itemType === 'image') continue; 

                // 1. Dosya sistemine ekle (eÄŸer yoksa)
                const rootPath = '/';
                if (!fileSystem[rootPath]) { fileSystem[rootPath] = {}; }

                if (!fileSystem[rootPath][itemName]) {
                    fileSystem[rootPath][itemName] = itemType; 
                    
                    if (itemType === 'dir') {
                        // KlasÃ¶r iÃ§eriÄŸini koru
                        fileSystem[rootPath + itemName] = fileSystem[rootPath + itemName] || {};
                    } 
                }

                // 2. MasaÃ¼stÃ¼ ikonunu oluÅŸtur (type bilgisini gÃ¶nder)
                const newIconElement = createDesktopIcon(itemName, iconId, itemType); 
                
                // 3. Konumunu yÃ¼kle - Ã‡akÄ±ÅŸan eski konumlarÄ± sÄ±fÄ±rlamak iÃ§in yeni konum bul
                const { top: initialTop, left: initialLeft } = findNextAvailableIconPosition();

                // Konumunu ata
                newIconElement.style.top = itemData.top || initialTop;
                newIconElement.style.left = itemData.left || initialLeft;

                // Konumu kaydet (BÃ¶ylece bir sonraki yÃ¼klemede yeni, Ã§akÄ±ÅŸmayan konumu kullanÄ±lÄ±r)
                saveDynamicItem(itemName, iconId, newIconElement.style.top, newIconElement.style.left, itemType, itemData.content); 
            }
        }

        // --- 9. KLASÃ–R SÄ°LME MANTIÄI (Dosyalar iÃ§in de Ã§alÄ±ÅŸÄ±r) ---

        function deleteDynamicFolder(iconElement) {
            const iconId = iconElement.id;
            const itemName = iconElement.querySelector('.icon-label').textContent;

            const isFolder = iconId.startsWith('new-folder-icon-');
            const itemType = isFolder ? 'klasÃ¶r' : 'metin belgesi';

            if (!confirm(`'${itemName}' adlÄ± ${itemType}Ã¼ kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?`)) {
                return;
            }
            
            // 1. Dosya Sisteminden Sil
            const rootPath = '/';
            if (fileSystem[rootPath] && fileSystem[rootPath][itemName]) {
                delete fileSystem[rootPath][itemName]; 
                
                if (isFolder) {
                    delete fileSystem[rootPath + itemName]; 
                }
            }

            // 2. localStorage'dan Sil
            let items = JSON.parse(localStorage.getItem('dynamicDesktopItems')) || {};
            if (items[iconId]) {
                delete items[iconId];
                localStorage.setItem('dynamicDesktopItems', JSON.stringify(items));
            }

            iconElement.remove();
            
            if (fileManagerWindow.style.display === 'block' && currentPath.startsWith('/')) {
                if (currentPath === '/' + itemName) {
                    currentPath = '/';
                }
                renderFiles();
            }

            alert(`'${itemName}' baÅŸarÄ±yla silindi.`);
        }

        // --- 9b. YENÄ°DEN ADLANDIRMA MANTIÄI (KlasÃ¶rler ve Dosyalar iÃ§in) ---

        function renameDynamicItem(iconElement) {
            const iconId = iconElement.id;
            const oldName = iconElement.querySelector('.icon-label').textContent;
            const itemType = iconId.startsWith('new-folder-icon-') ? 'dir' : 'file';
            const isFolder = itemType === 'dir';

            let newName = prompt(`"${oldName}" Ã¶ÄŸesini yeniden adlandÄ±r:`, oldName);

            if (newName) {
                newName = newName.trim();
                if (newName === oldName || newName.length === 0) {
                    return; // Ad deÄŸiÅŸmedi veya boÅŸ
                }
                
                // UzantÄ± kontrolÃ¼ (Sadece dosyalarda)
                if (!isFolder && !newName.includes('.') && oldName.includes('.')) {
                    const extension = oldName.substring(oldName.lastIndexOf('.'));
                    newName += extension;
                }

                const rootPath = '/';
                const currentItems = fileSystem[rootPath] || {};

                // Ã‡akÄ±ÅŸma kontrolÃ¼
                if (currentItems[newName]) {
                    alert(`Hata: "${newName}" adÄ±nda bir Ã¶ÄŸe zaten mevcut.`);
                    return;
                }

                // 1. Dosya Sistemini GÃ¼ncelle
                if (currentItems[oldName]) {
                    currentItems[newName] = currentItems[oldName];
                    delete currentItems[oldName];
                    
                    if (isFolder) {
                        // EÄŸer klasÃ¶rse, klasÃ¶r iÃ§eriÄŸinin yolunu da gÃ¼ncelle
                        fileSystem[rootPath + newName] = fileSystem[rootPath + oldName];
                        delete fileSystem[rootPath + oldName];
                    }
                } else {
                    alert("Hata: Ã–ÄŸeyi dosya sisteminde bulamadÄ±.");
                    return;
                }

                // 2. MasaÃ¼stÃ¼ Ä°konunu GÃ¼ncelle
                iconElement.querySelector('.icon-label').textContent = newName;

                // 3. localStorage'Ä± GÃ¼ncelle
                let items = JSON.parse(localStorage.getItem('dynamicDesktopItems')) || {};
                if (items[iconId]) {
                    items[iconId].name = newName;
                    localStorage.setItem('dynamicDesktopItems', JSON.stringify(items));
                }

                alert(`"${oldName}" baÅŸarÄ±yla "${newName}" olarak yeniden adlandÄ±rÄ±ldÄ±.`);
                
                // Dosya YÃ¶neticisi aÃ§Ä±ksa gÃ¼nceller
                if (fileManagerWindow.style.display === 'block' && currentPath === '/') {
                    renderFiles();
                }
            }
        }


        // --- 10. METÄ°N EDÄ°TÃ–RÃœ MANTIÄI ---
        const editorTitle = document.getElementById('text-editor-title');
        const editorTextarea = document.getElementById('editor-textarea');
        const editorSaveBtn = document.getElementById('editor-save-btn');
        const editorClearBtn = document.getElementById('editor-clear-btn');
        let currentEditingFileId = null; 

        // DosyayÄ± editÃ¶rde aÃ§ar ve iÃ§eriÄŸi yÃ¼kler
        function openTextEditor(fileName) {
            
            // Ä°lgili dosyanÄ±n ID'sini bul (Dinamik Dosyalar)
            let items = JSON.parse(localStorage.getItem('dynamicDesktopItems')) || {};
            for (const id in items) {
                if (items[id].name === fileName && items[id].type === 'file') {
                    currentEditingFileId = id;
                    const content = items[id].content || '';
                    
                    editorTitle.textContent = `ğŸ“„ Metin EditÃ¶rÃ¼ - ${fileName}`;
                    editorTextarea.value = content;
                    editorTextarea.disabled = false;
                    editorSaveBtn.style.display = 'inline-block';

                    openWindow(textEditorWindow, textEditorTaskbarIcon);
                    return;
                }
            }
            
            // Sabit Sistem DosyalarÄ±
            if (fileSystem['/'] && fileSystem['/'][fileName] === 'file') {
                editorTitle.textContent = `ğŸ“„ Metin EditÃ¶rÃ¼ - ${fileName} (Salt Okunur)`;
                editorTextarea.value = `Bu, KutOS'un sabit bir sistem dosyasÄ±dÄ±r. DÃ¼zenlenemez: ${fileName}`;
                editorTextarea.disabled = true;
                editorSaveBtn.style.display = 'none';
                openWindow(textEditorWindow, textEditorTaskbarIcon);
            }
        }
        
        // EditÃ¶r iÃ§eriÄŸini kaydeder
        editorSaveBtn.addEventListener('click', () => {
            if (!currentEditingFileId) return; 
            
            let items = JSON.parse(localStorage.getItem('dynamicDesktopItems')) || {};
            
            if (items[currentEditingFileId]) {
                items[currentEditingFileId].content = editorTextarea.value;
                localStorage.setItem('dynamicDesktopItems', JSON.stringify(items));
                alert(`"${items[currentEditingFileId].name}" dosyasÄ± baÅŸarÄ±yla kaydedildi!`);
            }
        });
        
        // EditÃ¶r iÃ§eriÄŸini temizler
        editorClearBtn.addEventListener('click', () => {
            editorTextarea.value = '';
        });


        // --- 11. Uygulama TanÄ±mlama ve BaÅŸlatÄ±cÄ± ---
        
        // PENCERE REFERANSLARI
        const settingsWindow = document.getElementById('settings-window');
        const calculatorWindow = document.getElementById('calculator-window');
        const securityWindow = document.getElementById('security-window'); 
        const browserWindow = document.getElementById('browser-window');

        // PENCERE KONUMLARINI AYARLAMA 
        fileManagerWindow.style.top = '100px';
        fileManagerWindow.style.left = '200px';
        textEditorWindow.style.top = '250px'; 
        textEditorWindow.style.left = '400px'; 
        settingsWindow.style.top = '150px';
        settingsWindow.style.left = '250px';
        calculatorWindow.style.top = '400px';
        calculatorWindow.style.left = '100px';
        securityWindow.style.top = '350px'; 
        securityWindow.style.left = '450px'; 
        browserWindow.style.top = '200px';
        browserWindow.style.left = '300px';
        
        // BAÅLIK REFERANSLARI
        const fileManagerHeader = fileManagerWindow.querySelector('.window-header');
        const textEditorHeader = textEditorWindow.querySelector('.window-header');
        const settingsHeader = settingsWindow.querySelector('.window-header');
        const calculatorHeader = calculatorWindow.querySelector('.window-header');
        const securityHeader = securityWindow.querySelector('.window-header'); 
        const browserHeader = browserWindow.querySelector('.window-header');
        
        // GÃ–REV Ã‡UBUÄU REFERANSLARI
        const settingsTaskbarIcon = document.getElementById('settings-taskbar-icon');
        const calculatorTaskbarIcon = document.getElementById('calculator-taskbar-icon');
        const securityTaskbarIcon = document.getElementById('security-taskbar-icon'); 
        const browserTaskbarIcon = document.getElementById('browser-taskbar-icon');
        
        // MASAÃœSTÃœ Ä°KON REFERANSLARI
        const fileManagerIcon = document.getElementById('file-manager-icon');
        const settingsIcon = document.getElementById('settings-icon-desktop');
        const browserIconDesktop = document.getElementById('browser-icon');
        
        // SABÄ°T Ä°KONLARIN BAÅLANGIÃ‡ KONUMLARI
        fileManagerIcon.style.top = '20px';
        fileManagerIcon.style.left = '20px';
        settingsIcon.style.top = '100px';
        settingsIcon.style.left = '20px';
        browserIconDesktop.style.top = '180px';
        browserIconDesktop.style.left = '20px';
        
        // MENÃœ REFERANSLARI
        const menuFileManager = document.getElementById('menu-file-manager');
        const menuTextEditor = document.getElementById('menu-text-editor');
        const menuSettings = document.getElementById('menu-settings');
        const menuCalculator = document.getElementById('menu-calculator');
        const menuSecurity = document.getElementById('menu-security'); 
        const menuBrowser = document.getElementById('menu-browser');
        const menuPowerOff = document.getElementById('menu-power-off'); 

        
        // KURULUMLAR: Kontroller, SÃ¼rÃ¼kleme, Fokus
        setupWindowControls(fileManagerWindow, fileManagerTaskbarIcon); makeDraggable(fileManagerWindow, fileManagerHeader); setupWindowFocus(fileManagerWindow);
        setupWindowControls(textEditorWindow, textEditorTaskbarIcon); makeDraggable(textEditorWindow, textEditorHeader); setupWindowFocus(textEditorWindow);
        setupWindowControls(settingsWindow, settingsTaskbarIcon); makeDraggable(settingsWindow, settingsHeader); setupWindowFocus(settingsWindow);
        setupWindowControls(calculatorWindow, calculatorTaskbarIcon); makeDraggable(calculatorWindow, calculatorHeader); setupWindowFocus(calculatorWindow);
        setupWindowControls(securityWindow, securityTaskbarIcon); makeDraggable(securityWindow, securityHeader); setupWindowFocus(securityWindow);
        setupWindowControls(browserWindow, browserTaskbarIcon); makeDraggable(browserWindow, browserHeader); setupWindowFocus(browserWindow);

        // SABÄ°T SÄ°MGE BAÄLANTILARI
        fileManagerIcon.addEventListener('dblclick', (e) => { 
            e.stopPropagation(); 
            openWindow(fileManagerWindow, fileManagerTaskbarIcon); currentPath = '/'; renderFiles(); 
        });
        settingsIcon.addEventListener('dblclick', (e) => { 
            e.stopPropagation(); 
            openWindow(settingsWindow, settingsTaskbarIcon); 
        });
        browserIconDesktop.addEventListener('dblclick', (e) => { 
            e.stopPropagation(); 
            openWindow(browserWindow, browserTaskbarIcon); 
        });

        
        // --- 12. HESAP MAKÄ°NESÄ° MANTIÄI ---
        const display = document.getElementById('calculator-display');
        const buttons = calculatorWindow.querySelector('.calculator-buttons');
        let firstValue = null;
        let operator = null;
        let waitingForSecondValue = false;

        function updateDisplay(value) { display.value = value; }
        function handleNumber(value) {
            if (waitingForSecondValue) {
                updateDisplay(value === '.' ? '0.' : value);
                waitingForSecondValue = false;
            } else {
                if (value === '.' && display.value.includes('.')) return;
                let newValue = display.value === '0' && value !== '.' ? value : display.value + value;
                updateDisplay(newValue);
            }
        }
        function handleOperator(nextOperator) {
            const inputValue = parseFloat(display.value);
            if (firstValue === null) {
                firstValue = inputValue;
            } else if (operator) {
                const result = performCalculation[operator](firstValue, inputValue);
                updateDisplay(String(result));
                firstValue = result;
            }
            waitingForSecondValue = true;
            operator = nextOperator;
        }
        function handleSpecialAction(action) {
            let value = parseFloat(display.value);
            if (action === 'clear') {
                firstValue = null; operator = null; waitingForSecondValue = false; updateDisplay('0');
            } else if (action === 'sign') {
                updateDisplay(String(value * -1));
            } else if (action === 'percent') {
                updateDisplay(String(value / 100));
            }
        }
        const performCalculation = {
            'add': (first, second) => first + second,
            'subtract': (first, second) => first - second,
            'multiply': (first, second) => first * second,
            'divide': (first, second) => first / second,
            'calculate': (first, second) => second 
        };
        buttons.addEventListener('click', (event) => {
            const target = event.target;
            if (!target.classList.contains('btn')) return;
            if (target.classList.contains('number')) { handleNumber(target.dataset.value); return; }
            if (target.classList.contains('operator')) { handleOperator(target.dataset.action); return; }
            if (target.dataset.action === 'calculate') {
                if (operator) { handleOperator(target.dataset.action); operator = null; waitingForSecondValue = false; firstValue = null; return; }
            }
            handleSpecialAction(target.dataset.action);
        });

        // --- 13. DOSYA YÃ–NETÄ°CÄ°SÄ° MANTIÄI ---
        const currentPathDisplay = document.getElementById('current-path');
        const fileListContainer = document.getElementById('file-list');
        let currentPath = '/';

        const fileSystem = {
            '/': {
                'MasaÃ¼stÃ¼': 'dir', 'Belgeler': 'dir', 'Sistem': 'dir',
                'KutOS_Lisans.txt': 'file', 
            },
            '/MasaÃ¼stÃ¼': { 'KÄ±sayol_1.lnk': 'file', 'Yeni KlasÃ¶r': 'dir' },
            '/Belgeler': { 'Rapor.pdf': 'file', 'Yemek_Tarifleri.doc': 'file' },
            '/Sistem': { 'Kernel.sys': 'file', 'Logs': 'dir' },
            '/Sistem/Logs': { 'hata_kaydi.log': 'file' }
        };

        function renderFiles() {
            if (!fileSystem[currentPath]) { fileListContainer.innerHTML = 'Hata: KlasÃ¶r bulunamadÄ±.'; return; }
            fileListContainer.innerHTML = '';
            currentPathDisplay.textContent = currentPath;
            const currentDir = fileSystem[currentPath];
            const items = Object.keys(currentDir).sort();

            if (currentPath !== '/') fileListContainer.appendChild(createFileItem('..', 'up'));

            items.forEach(itemName => {
                const type = currentDir[itemName];
                fileListContainer.appendChild(createFileItem(itemName, type));
            });
        }
        function createFileItem(name, type) {
            const item = document.createElement('div');
            item.classList.add('file-item'); item.dataset.name = name; item.dataset.type = type;
            let icon = '';
            if (type === 'dir' || type === 'up') {
                icon = (type === 'up') ? 'ğŸ”™' : 'ğŸ“'; item.classList.add('folder');
            } else if (type === 'file') {
                icon = 'ğŸ“„'; item.classList.add('document');
            }
            item.innerHTML = `<span class="file-icon">${icon}</span><span class="file-name">${name}</span>`;
            item.addEventListener('click', () => { handleFileClick(name, type); });
            item.addEventListener('dblclick', () => { 
                if (type === 'file') {
                    openTextEditor(name); 
                } 
            });

            return item;
        }
        function handleFileClick(name, type) {
            if (type === 'dir') {
                currentPath = (currentPath === '/') ? '/' + name : currentPath + '/' + name; renderFiles();
            } else if (type === 'up') {
                if (currentPath.lastIndexOf('/') > 0) currentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                else currentPath = '/';
                renderFiles();
            } else if (type === 'file') {
                // Tek tÄ±klama dosya seÃ§me simÃ¼lasyonu
            }
        }
        
        // Dosya YÃ¶neticisi BaÅŸlatma BaÄŸlantÄ±larÄ±
        menuFileManager.addEventListener('click', (e) => { 
            e.preventDefault(); openWindow(fileManagerWindow, fileManagerTaskbarIcon); renderFiles(); 
        });


        // --- 14. AYARLAR MANTIÄI VE BAÅLATICI ---
        const desktopElement = document.getElementById('desktop');
        const defaultBgBtn = document.getElementById('set-bg-default');
        const solidBgBtn = document.getElementById('set-bg-solid');

        function setBackground(type) {
            document.querySelectorAll('.settings-btn').forEach(btn => {
                btn.classList.remove('active-setting');
            });
            if (type === 'default') {
                desktopElement.style.backgroundImage = "url('kutos_wallpaper.png')";
                desktopElement.style.backgroundColor = "#0f0f1b";
                desktopElement.style.backgroundSize = "cover";
                defaultBgBtn.classList.add('active-setting');
            } else if (type === 'solid') {
                desktopElement.style.backgroundImage = "none";
                desktopElement.style.backgroundColor = "black";
                solidBgBtn.classList.add('active-setting');
            }
        }
        setBackground('default'); 

        defaultBgBtn.addEventListener('click', () => setBackground('default'));
        solidBgBtn.addEventListener('click', () => setBackground('solid'));


        // DiÄŸer Uygulama BaÅŸlatma BaÄŸlantÄ±larÄ±
        menuSettings.addEventListener('click', (e) => { e.preventDefault(); openWindow(settingsWindow, settingsTaskbarIcon); });
        menuBrowser.addEventListener('click', (e) => { e.preventDefault(); openWindow(browserWindow, browserTaskbarIcon); });
        menuCalculator.addEventListener('click', (e) => { e.preventDefault(); openWindow(calculatorWindow, calculatorTaskbarIcon); });
        menuSecurity.addEventListener('click', (e) => { e.preventDefault(); openWindow(securityWindow, securityTaskbarIcon); });
        menuTextEditor.addEventListener('click', (e) => { e.preventDefault(); openTextEditor('Yeni Belge.txt'); }); 


        // --- 15. KUTOS GÃœVENLÄ°K MANTIÄI ---
        const startScanBtn = document.getElementById('start-scan-btn');
        const scanResultDiv = document.getElementById('scan-result');
        const securityStatusDiv = document.getElementById('security-status');

        startScanBtn.addEventListener('click', () => {
            securityStatusDiv.innerHTML = 'ğŸŸ¡ Tarama BaÅŸlatÄ±lÄ±yor... LÃ¼tfen Bekleyin.';
            securityStatusDiv.style.borderColor = '#FFC107';
            securityStatusDiv.style.backgroundColor = '#fff8e1';
            securityStatusDiv.style.color = '#FFC107';
            scanResultDiv.textContent = '';
            startScanBtn.disabled = true;

            setTimeout(() => {
                const hasVirus = Math.random() < 0.1; 

                if (hasVirus) {
                    securityStatusDiv.innerHTML = 'ğŸ”´ TEHLÄ°KE! VirÃ¼s Bulundu!';
                    securityStatusDiv.style.borderColor = '#F44336';
                    securityStatusDiv.style.backgroundColor = '#ffebee';
                    securityStatusDiv.style.color = '#F44336';
                    scanResultDiv.textContent = 'Tespit Edilen Tehdit: Trojan.SnakeGame.exe (Silindi)';
                } else {
                    securityStatusDiv.innerHTML = 'âœ… Sistem GÃ¼venli: Her ÅŸey yolunda.';
                    securityStatusDiv.style.borderColor = '#4CAF50';
                    securityStatusDiv.style.backgroundColor = '#e8f5e9';
                    securityStatusDiv.style.color = '#4CAF50';
                    scanResultDiv.textContent = 'Tarama TamamlandÄ±. HiÃ§bir tehdit bulunamadÄ±.';
                }
                startScanBtn.disabled = false;
            }, 3000); 
        });


        // --- 16. Kapat Butonu Ä°ÅŸlevi (GeliÅŸtirilmiÅŸ SimÃ¼lasyon) ---
        menuPowerOff.addEventListener('click', (e) => {
            e.preventDefault();
            startMenu.style.display = 'none';

            document.body.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; font-family: sans-serif; font-size: 24px; transition: background 2s ease-out;">
                    <p>KutOS KapatÄ±lÄ±yor...</p>
                    <p style="font-size: 16px; margin-top: 50px;">GÃ¶rÃ¼ÅŸmek Ã¼zere!</p>
                </div>
            `;
            
            setTimeout(() => {
                 // window.close();
            }, 3000); 
        });


        // --- 17. BAÄLAM MENÃœSÃœ (SAÄ TIK) MANTIÄI ---
        const createFolderBtn = document.getElementById('menu-create-folder');
        const createFileBtn = document.getElementById('menu-create-file'); 
        const refreshBtn = document.getElementById('menu-refresh');
        const viewSettingsBtn = document.getElementById('menu-view-settings');
        
        desktopArea.addEventListener('contextmenu', (e) => {
            e.preventDefault(); 
            contextMenu.style.display = 'block';
            folderContextMenu.style.display = 'none';

            if (e.target.closest('.desktop-icon') || e.target.closest('.window')) {
                contextMenu.style.display = 'none';
                return;
            }
            
            const menuWidth = contextMenu.offsetWidth;
            const menuHeight = contextMenu.offsetHeight;
            const x = e.clientX;
            const y = e.clientY;
            
            if (x + menuWidth > window.innerWidth) { contextMenu.style.left = `${x - menuWidth}px`; } 
            else { contextMenu.style.left = `${x}px`; }
            
            if (y + menuHeight > window.innerHeight - 40) { contextMenu.style.top = `${y - menuHeight}px`; } 
            else { contextMenu.style.top = `${y}px`; }
        });
        
        // Yeni KlasÃ¶r OluÅŸturma
        createFolderBtn.addEventListener('click', () => {
            let folderName = prompt("OluÅŸturulacak klasÃ¶rÃ¼n adÄ±nÄ± girin (Ã–rn: Yeni KlasÃ¶rÃ¼m):");
            
            if (folderName) {
                folderName = folderName.trim(); 
                
                if (folderName.length > 0) {
                    const rootPath = '/';
                    
                    if (!fileSystem[rootPath]) { fileSystem[rootPath] = {}; }

                    if (!fileSystem[rootPath][folderName]) {
                        
                        const newIconId = 'new-folder-icon-' + Date.now();
                        // Otomatik konum bulma
                        const { top: initialTop, left: initialLeft } = findNextAvailableIconPosition();
                        
                        fileSystem[rootPath][folderName] = 'dir';
                        fileSystem[rootPath + folderName] = {}; 
                        
                        createDesktopIcon(folderName, newIconId, 'dir'); 
                        
                        // Konumunu ata
                        const newIconElement = document.getElementById(newIconId);
                        if (newIconElement) {
                            newIconElement.style.top = initialTop;
                            newIconElement.style.left = initialLeft;
                        }
                        
                        saveDynamicItem(folderName, newIconId, initialTop, initialLeft, 'dir'); 
                        
                        alert(`'${folderName}' klasÃ¶rÃ¼ baÅŸarÄ±yla oluÅŸturuldu!`);
                        
                        if (fileManagerWindow.style.display === 'block' && currentPath === '/') {
                            renderFiles();
                        }
                    } else {
                        alert(`Hata: '${folderName}' adÄ±nda bir klasÃ¶r/dosya zaten mevcut.`);
                    }
                } else {
                    alert("KlasÃ¶r adÄ± boÅŸ bÄ±rakÄ±lamaz.");
                }
            }
            contextMenu.style.display = 'none'; 
        });
        
        // Yeni Metin Belgesi OluÅŸturma
        createFileBtn.addEventListener('click', () => {
            let fileName = prompt("OluÅŸturulacak dosyanÄ±n adÄ±nÄ± girin (Ã–rn: notlar.txt):");
            
            if (fileName) {
                fileName = fileName.trim(); 
                
                if (fileName.length > 0) {
                    if (!fileName.toLowerCase().includes('.')) {
                        fileName += '.txt';
                    }

                    const rootPath = '/';
                    
                    if (!fileSystem[rootPath]) { fileSystem[rootPath] = {}; }

                    if (!fileSystem[rootPath][fileName]) {
                        
                        const newIconId = 'new-file-icon-' + Date.now();
                        // Otomatik konum bulma
                        const { top: initialTop, left: initialLeft } = findNextAvailableIconPosition();
                        
                        fileSystem[rootPath][fileName] = 'file';
                        
                        createDesktopIcon(fileName, newIconId, 'file');
                        
                        // Konumunu ata
                        const newIconElement = document.getElementById(newIconId);
                        if (newIconElement) {
                            newIconElement.style.top = initialTop;
                            newIconElement.style.left = initialLeft;
                        }

                        saveDynamicItem(fileName, newIconId, initialTop, initialLeft, 'file');
                        
                        alert(`'${fileName}' metin belgesi baÅŸarÄ±yla oluÅŸturuldu!`);
                        
                        if (fileManagerWindow.style.display === 'block' && currentPath === '/') {
                            renderFiles();
                        }

                    } else {
                        alert(`Hata: '${fileName}' adÄ±nda bir dosya/klasÃ¶r zaten mevcut.`);
                    }
                } else {
                    alert("Dosya adÄ± boÅŸ bÄ±rakÄ±lamaz.");
                }
            }
            contextMenu.style.display = 'none'; 
        });


        // Yenileme
        refreshBtn.addEventListener('click', () => {
            alert("MasaÃ¼stÃ¼ yenileniyor...");
            window.location.reload(); 
        });
        
        // GÃ¶rÃ¼ntÃ¼ AyarlarÄ±nÄ± AÃ§ma
        viewSettingsBtn.addEventListener('click', () => {
            openWindow(settingsWindow, settingsTaskbarIcon); 
        });

        // KLASÃ–R BAÄLAM MENÃœSÃœ Ä°ÅLEVLERÄ°
        const menuDeleteFolder = document.getElementById('menu-delete-folder');
        const menuOpenFolder = document.getElementById('menu-open-folder');
        const menuRenameItem = document.getElementById('menu-rename-item');

        menuDeleteFolder.addEventListener('click', () => {
            if (activeFolderIcon) {
                deleteDynamicFolder(activeFolderIcon);
            }
            folderContextMenu.style.display = 'none';
            activeFolderIcon = null;
        });

        menuOpenFolder.addEventListener('click', () => {
             if (activeFolderIcon) {
                openWindow(fileManagerWindow, fileManagerTaskbarIcon); 
                
                const folderName = activeFolderIcon.querySelector('.icon-label').textContent;
                
                currentPath = '/' + folderName;
                renderFiles(); 
            }
            folderContextMenu.style.display = 'none';
            activeFolderIcon = null;
        });
        
        menuRenameItem.addEventListener('click', () => {
            if (activeFolderIcon) {
                renameDynamicItem(activeFolderIcon);
            }
            folderContextMenu.style.display = 'none';
            activeFolderIcon = null;
        });


        // --- SON KURULUM ---
        document.querySelectorAll('.window').forEach(win => {
            const header = win.querySelector('.window-header');
            if (header) {
                makeDraggable(win, header);
                setupWindowFocus(win);
            }
        });

        loadIconPositions(); 

    </script>
</body>
</html>

